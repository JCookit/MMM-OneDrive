/*! *****************************************************************************
  MMM-OneDrive
  Version 1.6.0

  MagicMirror² module to display your photos from OneDrive.
  Please submit bugs at https://github.com/hermanho/MMM-OneDrive/issues

  (c) hermanho
  Licence: MIT

  This file is auto-generated. Do not edit.
***************************************************************************** */

!function(){"use strict";Module.register("MMM-OneDrive",{defaults:{albums:[],updateInterval:3e4,sort:"new",condition:{fromDate:null,toDate:null,minWidth:null,maxWidth:null,minHeight:null,maxHeight:null,minWHRatio:null,maxWHRatio:null},showWidth:1080,showHeight:1920,timeFormat:"YYYY/MM/DD HH:mm",autoInfoPosition:!1,forceAuthInteractive:!1,leftMargin:null,kenBurnsEffect:!0,kenBurnsCenterStart:!0,faceDetection:{enabled:!0,minFaceSize:50,maxFaceSize:300,confidenceThreshold:.5,debugMode:!1}},requiresVersion:"2.24.0",suspended:!1,getScripts:()=>["moment.js"],getStyles:function(){return["MMM-OneDrive.css"]},start:function(){this.firstScan=!0,this.config.updateInterval<1e4&&(this.config.updateInterval=1e4),this.config.condition=Object.assign({},this.defaults.condition,this.config.condition);const e=Object.assign({},this.config);for(let t=0;t<this.config.albums.length;t++){const n=this.config.albums[t];n instanceof RegExp&&(e.albums[t]={source:n.source,flags:n.flags})}this.photoCache=null,this.displayTimer=null,this.processingRequested=!1,console.log("[MMM-OneDrive] Frontend initialized with caching system"),this.sendSocketNotification("INIT",e),this.dynamicPosition=0,this.requestNextPhoto()},socketNotificationReceived:function(e,t){if("ERROR"===e){const e=document.getElementById("ONEDRIVE_PHOTO_CURRENT");e.textContent="";const n=document.createElement("div");Object.assign(n.style,{display:"flex",justifyContent:"center",alignItems:"center",height:"100%"});const i=document.createElement("div");Object.assign(i.style,{maxWidth:"70vw",fontSize:"1.5em"}),i.textContent=t,n.appendChild(i),e.appendChild(n)}if("SCAN_COMPLETE"===e&&(console.log("[MMM-OneDrive] 📦 Scan complete - requesting photo"),this.requestNextPhoto()),"CLEAR_ERROR"===e){document.getElementById("ONEDRIVE_PHOTO_CURRENT").textContent="",this.requestNextPhoto()}if("UPDATE_STATUS"===e){document.getElementById("ONEDRIVE_PHOTO_INFO").innerHTML=String(t)}"NO_PHOTO"===e&&(this.processingRequested=!1),"RENDER_PHOTO"===e&&(console.log("[MMM-OneDrive] 💾 Photo received from backend, caching:",t.photo.filename),this.photoCache=t,this.processingRequested=!1,this.displayTimer?console.log("[MMM-OneDrive] 📦 Photo cached, waiting for display timer"):(console.log("[MMM-OneDrive] 🎬 First photo - displaying immediately"),this.displayCachedPhoto()))},notificationReceived:function(e,t,n){"ONEDRIVE_PHOTO_NEXT"===e&&this.skipToNextPhoto()},requestNextPhoto:function(){this.processingRequested?console.log("[MMM-OneDrive] Photo processing already in progress, skipping request"):(this.processingRequested=!0,console.log("[MMM-OneDrive] ➤ Requesting next photo from backend"),this.sendSocketNotification("NEXT_PHOTO",[]))},displayCachedPhoto:function(){if(!this.photoCache)return void console.warn("[MMM-OneDrive] ⚠ No cached photo available for display");console.log("[MMM-OneDrive] 📺 Displaying cached photo:",this.photoCache.photo.filename);const{photo:e,photoBase64:t,album:n,interestingRectangleResult:i}=this.photoCache,o=`data:${"image/heic"===e.mimeType?"image/jpeg":e.mimeType};base64,${t}`,a=(null==i?void 0:i.markedImageUrl)||o,s=(null==i?void 0:i.focalPoint)||null;this.render(a,e,n,s),this.requestNextPhoto(),this.scheduleNextDisplay()},scheduleNextDisplay:function(){this.displayTimer&&clearTimeout(this.displayTimer),console.log(`[MMM-OneDrive] ⏰ Next photo scheduled in ${this.config.updateInterval/1e3}s`),this.displayTimer=setTimeout((()=>{this.displayCachedPhoto()}),this.config.updateInterval)},skipToNextPhoto:function(){console.log("[MMM-OneDrive] ⏭ Skipping to next photo (user triggered)"),this.displayTimer&&clearTimeout(this.displayTimer),this.displayCachedPhoto()},createStaticKenBurnsKeyframes:function(){if(document.getElementById("ken-burns-static"))return;const e=document.createElement("style");e.id="ken-burns-static",e.textContent="\n      @keyframes ken-burns-static {\n        0% {\n          opacity: 0;\n          transform: scale(var(--start-scale, 1.5)) translate(var(--start-x, 0%), var(--start-y, 0%));\n          overflow: hidden;\n        }\n        10% {\n          opacity: 1;\n          overflow: hidden;\n        }\n        90% {\n          opacity: 1;\n          overflow: hidden;\n        }\n        100% {\n          opacity: 0;\n          transform: translate(0%, 0%) scale(1.0);\n          overflow: hidden;\n        }\n      }\n    ",document.head.appendChild(e)},createStaticBackdropKeyframes:function(){if(document.getElementById("backdrop-static"))return;const e=document.createElement("style");e.id="backdrop-static",e.textContent="\n    @keyframes backdrop-cycle {\n      0% {\n        opacity: 0;\n      }\n      10% {\n        opacity: 1;\n      }\n      90% {\n        opacity: 1;\n      }\n      100% {\n        opacity: 0;\n      }\n    }\n  ",document.head.appendChild(e)},render:function(e,t,n,i){if(this.suspended)return void console.debug("[MMM-OneDrive] Module is suspended, skipping render");const o=new Date,a=document.getElementById("ONEDRIVE_PHOTO_BACKDROP"),s=document.getElementById("ONEDRIVE_PHOTO_CURRENT");s.textContent="",a.style.backgroundImage=`url(${e})`,s.style.backgroundImage=`url(${e})`,a.style.animation="none",a.offsetHeight,this.createStaticBackdropKeyframes();const l=this.config.updateInterval/1e3;if(a.style.animation=`backdrop-cycle ${l}s linear forwards`,this.config.leftMargin){let e=document.getElementById("ONEDRIVE_PHOTO_CLIP_WRAPPER");if(!e){e=document.createElement("div"),e.id="ONEDRIVE_PHOTO_CLIP_WRAPPER",e.style.position="absolute",e.style.overflow="hidden",e.style.top="10px",e.style.bottom="10px";s.parentNode.insertBefore(e,s),e.appendChild(s)}e.style.left=this.config.leftMargin,e.style.right="10px",s.style.left="0",s.style.right="0",s.style.top="0",s.style.bottom="0",s.style.width="100%",s.style.height="100%",s.style.overflow="",s.style.backgroundPosition="center center",s.style.backgroundSize="contain"}else{const e=document.getElementById("ONEDRIVE_PHOTO_CLIP_WRAPPER");if(e){const t=e.parentNode;t.insertBefore(s,e),t.removeChild(e),s.style.left="10px",s.style.right="10px",s.style.top="10px",s.style.bottom="10px"}}s.style.removeProperty("animation"),s.style.removeProperty("overflow"),this.applyCommonStyling(s,t,n,o,!1!==this.config.kenBurnsEffect)},applyKenBurnsAnimation:function(e,t,n,i,o){const a=this.config.updateInterval/1e3;this.applyWebAnimationsKenBurns(e,t,n,i,a,o)},applyWebAnimationsKenBurns:function(e,t,n,i,o,a){var s,l;const r=Number(null===(s=i.mediaMetadata)||void 0===s?void 0:s.width)||0,d=Number(null===(l=i.mediaMetadata)||void 0===l?void 0:l.height)||0;let c=1.5;if(a&&r&&d){const e=a.width/r*100,t=a.height/d*100,n=100/e,i=100/t,o=Math.min(n,i);c=Math.max(1.1,Math.min(2.5,o)),console.debug("[MMM-OneDrive] Web Animations - Focal point scale calculation:",{focalWidthPercent:e.toFixed(1),focalHeightPercent:t.toFixed(1),optimalScale:o.toFixed(2),finalStartScale:c.toFixed(2)})}let m=0,h=0;a&&!1!==this.config.kenBurnsCenterStart&&(m=50-t,h=50-n,console.debug("[MMM-OneDrive] Web Animations - Pan calculation:",{focalCenter:`${t.toFixed(1)}%, ${n.toFixed(1)}%`,translation:`${m.toFixed(1)}%, ${h.toFixed(1)}%`})),e.kenBurnsAnimation&&(e.kenBurnsAnimation.cancel(),delete e.kenBurnsAnimation),e.style.animation="none",e.classList.remove("animated"),e.style.opacity="1",e.style.transform="",e.style.overflow="hidden";const u=[{opacity:0,transform:`scale(${c}) translate(${m}%, ${h}%)`},{opacity:1,transform:`scale(${c}) translate(${m}%, ${h}%)`,offset:.1},{opacity:1,transform:"scale(1.0) translate(0%, 0%)",offset:.9},{opacity:0,transform:"scale(1.0) translate(0%, 0%)"}],p=e.animate(u,{duration:1e3*o,easing:"linear",fill:"forwards"});e.kenBurnsAnimation=p,p.addEventListener("finish",(()=>{e.kenBurnsAnimation===p&&delete e.kenBurnsAnimation,console.debug("[MMM-OneDrive] Web Animation completed and cleaned up")})),p.addEventListener("cancel",(()=>{e.kenBurnsAnimation===p&&delete e.kenBurnsAnimation,console.debug("[MMM-OneDrive] Web Animation cancelled and cleaned up")})),console.debug("[MMM-OneDrive] Ken Burns Web Animation started:",{method:"Web Animations API",totalDuration:`${o}s`,filename:i.filename,hasFocalPoint:!!a,startScale:c.toFixed(2),translation:`${m}%, ${h}%`,keyframes:u.length})},applyCSSAnimationKenBurns:function(e,t,n,i,o,a){var s,l;this.createStaticKenBurnsKeyframes();const r=Number(null===(s=i.mediaMetadata)||void 0===s?void 0:s.width)||0,d=Number(null===(l=i.mediaMetadata)||void 0===l?void 0:l.height)||0;let c=1.5;if(a&&r&&d){const e=a.width/r*100,t=a.height/d*100,n=100/e,i=100/t,o=Math.min(n,i);c=Math.max(1.1,Math.min(2.5,o)),console.debug("[MMM-OneDrive] CSS Animation - Focal point scale calculation:",{focalWidthPercent:e.toFixed(1),focalHeightPercent:t.toFixed(1),optimalScale:o.toFixed(2),finalStartScale:c.toFixed(2)})}let m=0,h=0;a&&!1!==this.config.kenBurnsCenterStart&&(m=50-t,h=50-n,console.debug("[MMM-OneDrive] CSS Animation - Pan calculation:",{focalCenter:`${t.toFixed(1)}%, ${n.toFixed(1)}%`,translation:`${m.toFixed(1)}%, ${h.toFixed(1)}%`})),e.style.removeProperty("animation"),e.classList.remove("animated"),e.style.opacity="1",e.style.transform="",e.style.removeProperty("--start-scale"),e.style.removeProperty("--start-x"),e.style.removeProperty("--start-y"),e.style.setProperty("--start-scale",c.toString()),e.style.setProperty("--start-x",`${m}%`),e.style.setProperty("--start-y",`${h}%`),e.style.animation="none",e.offsetHeight,e.style.animation=`ken-burns-static ${o}s linear forwards`,e.style.overflow="hidden",e.addEventListener("animationend",(function t(){e.removeEventListener("animationend",t),e.style.removeProperty("--start-scale"),e.style.removeProperty("--start-x"),e.style.removeProperty("--start-y")})),console.debug("[MMM-OneDrive] Ken Burns animation (CSS):",{animation:"ken-burns-static",totalDuration:`${o}s`,filename:i.filename,hasFocalPoint:!!a,startScale:c.toFixed(2),translation:`${m}%, ${h}%`})},applyCommonStyling:function(e,t,n,i,o){var a,s;o||e.classList.add("animated");const l=document.getElementById("ONEDRIVE_PHOTO_INFO");if(this.config.autoInfoPosition){let e=(e,t)=>{const n=new Date;return[[0,"none","none",0],["none","none",0,0],["none",0,0,"none"],[0,0,"none","none"]][Math.floor(n.getMinutes()/15)]};"function"==typeof this.config.autoInfoPosition&&(e=this.config.autoInfoPosition);const[i,o,a,s]=e(n,t);l.style.setProperty("--top",String(i)),l.style.setProperty("--left",String(o)),l.style.setProperty("--bottom",String(a)),l.style.setProperty("--right",String(s))}l.innerHTML="";let r,d;t._folderId&&!n.bundle?(r=document.createElement("div"),r.classList.add("folderIcon"),r.innerHTML="",d=document.createElement("div"),d.classList.add("folderTitle"),d.innerHTML=n.name):(r=document.createElement("div"),r.classList.add("albumCover"),r.style.backgroundImage=`url(modules/MMM-OneDrive/cache/${n.id})`,d=document.createElement("div"),d.classList.add("albumTitle"),d.innerHTML=n.name);const c=document.createElement("div");c.classList.add("photoTime"),c.innerHTML="relative"===this.config.timeFormat?moment(t.mediaMetadata.dateTimeOriginal).fromNow():moment(t.mediaMetadata.dateTimeOriginal).format(this.config.timeFormat);const m=document.createElement("div");if(m.classList.add("photoLocation"),t.mediaMetadata.location){const e=t.mediaMetadata.location;if(e.city||e.state||e.country){const t=[e.city];!e.state||"united states"!==(null===(a=e.country)||void 0===a?void 0:a.toLowerCase())&&"canada"!==(null===(s=e.country)||void 0===s?void 0:s.toLowerCase())&&e.city||t.push(e.state),e.country&&t.push(e.country),m.innerHTML=t.filter(Boolean).join(", ")}else e.latitude&&e.longitude&&(m.innerHTML=`${e.latitude.toFixed(4)}, ${e.longitude.toFixed(4)}`)}const h=document.createElement("div");h.classList.add("infoText"),l.appendChild(r),h.appendChild(d),h.appendChild(c),m.innerHTML&&h.appendChild(m),l.appendChild(h),console.debug("[MMM-OneDrive] render image done",JSON.stringify({id:t.id,filename:t.filename,duration:(new Date).getTime()-i.getTime()}))},getDom:function(){const e=document.createElement("div");e.id="ONEDRIVE_PHOTO";const t=document.createElement("div");t.id="ONEDRIVE_PHOTO_BACKDROP";const n=document.createElement("div");n.id="ONEDRIVE_PHOTO_CURRENT",-1===this.data.position.search("fullscreen")&&(this.config.showWidth&&(e.style.width=this.config.showWidth+"px"),this.config.showHeight&&(e.style.height=this.config.showHeight+"px")),n.addEventListener("animationend",(()=>{n.classList.remove("animated")}));const i=document.createElement("div");return i.id="ONEDRIVE_PHOTO_INFO",i.innerHTML="Loading...",e.appendChild(t),e.appendChild(n),e.appendChild(i),console.info("[MMM-OneDrive] Dom updated!"),e},suspend(){console.log("[MMM-OneDrive] 💤 Module suspended - stopping display timer"),this.displayTimer&&(clearTimeout(this.displayTimer),this.displayTimer=null),this.sendSocketNotification("MODULE_SUSPENDED",void 0),this.suspended=!0;document.getElementById("ONEDRIVE_PHOTO_INFO").innerHTML=""},resume(){console.log("[MMM-OneDrive] 🔄 Module resumed - restarting display cycle"),this.sendSocketNotification("MODULE_RESUMED",void 0),this.suspended=!1,this.photoCache&&!this.displayTimer&&this.scheduleNextDisplay()}})}();
//# sourceMappingURL=MMM-OneDrive.js.map
