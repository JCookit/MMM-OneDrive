/*! *****************************************************************************
  MMM-OneDrive
  Version 1.6.0

  MagicMirror¬≤ module to display your photos from OneDrive.
  Please submit bugs at https://github.com/hermanho/MMM-OneDrive/issues

  (c) hermanho
  Licence: MIT

  This file is auto-generated. Do not edit.
***************************************************************************** */

!function(){"use strict";Module.register("MMM-OneDrive",{defaults:{albums:[],updateInterval:3e4,sort:"new",condition:{fromDate:null,toDate:null,minWidth:null,maxWidth:null,minHeight:null,maxHeight:null,minWHRatio:null,maxWHRatio:null},showWidth:1080,showHeight:1920,timeFormat:"YYYY/MM/DD HH:mm",autoInfoPosition:!1,forceAuthInteractive:!1,leftMargin:null,kenBurnsEffect:!0,kenBurnsCenterStart:!0,faceDetection:{enabled:!0,minFaceSize:50,maxFaceSize:300,confidenceThreshold:.5,debugMode:!1}},requiresVersion:"2.24.0",suspended:!1,getScripts:()=>["moment.js"],getStyles:function(){return["MMM-OneDrive.css"]},start:function(){this.firstScan=!0,this.config.updateInterval<1e4&&(this.config.updateInterval=1e4),this.config.condition=Object.assign({},this.defaults.condition,this.config.condition);const e=Object.assign({},this.config);for(let t=0;t<this.config.albums.length;t++){const n=this.config.albums[t];n instanceof RegExp&&(e.albums[t]={source:n.source,flags:n.flags})}this.photoCache=null,this.displayTimer=null,this.processingRequested=!1,this.currentBlobUrl=null,this.currentDebugBlobUrl=null,console.log("[MMM-OneDrive] Frontend initialized with caching system and blob URL management"),this.sendSocketNotification("INIT",e),this.dynamicPosition=0,this.requestNextPhoto()},getTextFriendlyColors:function(e,t=2){if(!e||0===e.length)return[];return e.slice(0,t).map(((e,t)=>{var n;const o=(null===(n=e.hsv)||void 0===n?void 0:n.v)||0;let i=[...e.rgb||[255,255,255]],s=!1;if(o<.45){const[e,t,n]=i;i=[Math.min(255,Math.round(e+.5*(255-e))),Math.min(255,Math.round(t+.5*(255-t))),Math.min(255,Math.round(n+.5*(255-n)))],s=!0}const a=`#${i.map((e=>e.toString(16).padStart(2,"0"))).join("")}`,r=(i[0]+i[1]+i[2])/765;return Object.assign(Object.assign({},e),{rgb:i,hexColor:a,brightness:r,wasBrightened:s,originalRgb:e.rgb,originalHex:e.hexColor,textRole:0===t?"date":"location"})}))},getMostVibrantColor:function(e){if(!e||0===e.length)return null;const t=e.filter((e=>!(e=>{const{h:t,s:n,v:o}=e.hsv||{h:0,s:0,v:0};return n<.2||o>.9&&n<.3||t>=20&&t<=60&&n<.3})(e))).map((e=>{var t,n;return Object.assign(Object.assign({},e),{vibrancyScore:((null===(t=e.hsv)||void 0===t?void 0:t.s)||0)*((null===(n=e.hsv)||void 0===n?void 0:n.v)||0)*(e.unifiedScore||0)})})).sort(((e,t)=>t.vibrancyScore-e.vibrancyScore));return t.length>0?t[0]:null},applyPhotoInfoStyling:function(e,t,n,o){if(o){const t=o.hexColor,n=(o.rgb||[100,100,100]).map((e=>Math.max(0,Math.round(.5*e)))),i=`rgba(${n[0]}, ${n[1]}, ${n[2]}, 0.8)`;e.style.borderLeft=`4px solid ${t}`,e.style.backgroundColor=i,console.debug(`[MMM-OneDrive] Applied vibrant theming: ${t} with darkened background`)}else e.style.borderLeft="4px solid white",e.style.backgroundColor="rgba(0, 0, 0, 0.8)",console.debug("[MMM-OneDrive] Using default white border theming");t.style.color="white",t.style.fontWeight="bold",n.innerHTML&&(n.style.color="white",n.style.fontWeight="normal")},socketNotificationReceived:function(e,t){if("ERROR"===e){const e=document.getElementById("ONEDRIVE_PHOTO_CURRENT");e.textContent="";const n=document.createElement("div");Object.assign(n.style,{display:"flex",justifyContent:"center",alignItems:"center",height:"100%"});const o=document.createElement("div");Object.assign(o.style,{maxWidth:"70vw",fontSize:"1.5em"}),o.textContent=t,n.appendChild(o),e.appendChild(n)}if("SCAN_COMPLETE"===e&&(console.log("[MMM-OneDrive] üì¶ Scan complete - requesting photo"),this.requestNextPhoto()),"CLEAR_ERROR"===e){document.getElementById("ONEDRIVE_PHOTO_CURRENT").textContent="",this.requestNextPhoto()}if("UPDATE_STATUS"===e){document.getElementById("ONEDRIVE_PHOTO_INFO").innerHTML=String(t)}"NO_PHOTO"===e&&(this.processingRequested=!1),"RENDER_PHOTO"===e&&(console.log("[MMM-OneDrive] üíæ Photo received from backend, caching:",t.photo.filename),this.photoCache=t,this.processingRequested=!1,this.displayTimer?console.log("[MMM-OneDrive] üì¶ Photo cached, waiting for display timer"):(console.log("[MMM-OneDrive] üé¨ First photo - displaying immediately"),this.displayCachedPhoto()))},notificationReceived:function(e,t,n){"ONEDRIVE_PHOTO_NEXT"===e&&this.skipToNextPhoto()},requestNextPhoto:function(){this.processingRequested?console.log("[MMM-OneDrive] Photo processing already in progress, skipping request"):(this.processingRequested=!0,console.log("[MMM-OneDrive] ‚û§ Requesting next photo from backend"),this.sendSocketNotification("NEXT_PHOTO",[]))},displayCachedPhoto:function(){var e;if(!this.photoCache)return void console.warn("[MMM-OneDrive] ‚ö† No cached photo available for display");console.log("[MMM-OneDrive] üì∫ Displaying cached photo:",this.photoCache.photo.filename);const{photo:t,photoBuffer:n,mimeType:o,album:i,interestingRectangleResult:s}=this.photoCache;console.debug("[MMM-OneDrive] Photo cache contents:",{hasPhotoBuffer:!!n,photoBufferSize:(null==n?void 0:n.length)||0,mimeType:o,hasInterestingRectangleResult:!!s,hasDebugImageBuffer:!!(null==s?void 0:s.debugImageBuffer),debugImageBufferSize:(null===(e=null==s?void 0:s.debugImageBuffer)||void 0===e?void 0:e.length)||0});const a=new Blob([n],{type:o}),r=URL.createObjectURL(a);this.currentBlobUrl&&URL.revokeObjectURL(this.currentBlobUrl),this.currentBlobUrl=r;let l=r;if(null==s?void 0:s.debugImageBuffer)try{console.debug("[MMM-OneDrive] üîç Processing debug image buffer...");const e=new Blob([s.debugImageBuffer],{type:"image/jpeg"}),t=URL.createObjectURL(e);this.currentDebugBlobUrl&&URL.revokeObjectURL(this.currentDebugBlobUrl),this.currentDebugBlobUrl=t,l=t,console.debug(`[MMM-OneDrive] ‚úÖ Created debug image blob URL (${s.debugImageBuffer.length} bytes)`)}catch(e){console.error("[MMM-OneDrive] ‚ùå Failed to create debug image blob URL:",e),l=r}else console.debug("[MMM-OneDrive] ‚ÑπÔ∏è No debug image buffer found, using main image");console.debug("[MMM-OneDrive] Display URL type: "+(l.startsWith("blob:")?"blob":"other")),this.render(l,t,i,s),this.requestNextPhoto(),this.scheduleNextDisplay()},scheduleNextDisplay:function(){this.displayTimer&&clearTimeout(this.displayTimer),console.log(`[MMM-OneDrive] ‚è∞ Next photo scheduled in ${this.config.updateInterval/1e3}s`),this.displayTimer=setTimeout((()=>{this.displayCachedPhoto()}),this.config.updateInterval)},skipToNextPhoto:function(){console.log("[MMM-OneDrive] ‚è≠ Skipping to next photo (user triggered)"),this.displayTimer&&clearTimeout(this.displayTimer),this.displayCachedPhoto()},createStaticKenBurnsKeyframes:function(){if(document.getElementById("ken-burns-keyframes"))return;const e=document.createElement("style");e.id="ken-burns-keyframes",e.textContent="\n      /* Hardware acceleration optimization for Ken Burns */\n      #ONEDRIVE_PHOTO_CURRENT, #ONEDRIVE_PHOTO_CURRENT img {\n        /* Force GPU acceleration */\n        will-change: transform, opacity;\n        transform-style: preserve-3d;\n        backface-visibility: hidden;\n        \n        /* Optimize rendering */\n        -webkit-font-smoothing: antialiased;\n        -moz-osx-font-smoothing: grayscale;\n        \n        /* Ensure hardware compositing */\n        transform: translateZ(0);\n      }\n\n      /* Static animation - fade in/out only, no movement */\n      @keyframes ken-burns-static {\n        0% {\n          opacity: 0;\n        }\n        10% {\n          opacity: 1;\n        }\n        90% {\n          opacity: 1;\n        }\n        100% {\n          opacity: 0;\n        }\n      }\n\n      /* Zoom out animation - start zoomed in, end at natural size */\n      @keyframes ken-burns-zoom-out {\n        0% {\n          opacity: 0;\n          transform: scale3d(var(--start-scale, 1.5), var(--start-scale, 1.5), 1) \n                     translate3d(var(--start-x, 0%), var(--start-y, 0%), 0);\n        }\n        10% {\n          opacity: 1;\n        }\n        90% {\n          opacity: 1;\n        }\n        100% {\n          opacity: 0;\n          transform: scale3d(1.0, 1.0, 1) translate3d(0%, 0%, 0);\n        }\n      }\n\n      /* Zoom in animation - start at natural size, end zoomed in */\n      @keyframes ken-burns-zoom-in {\n        0% {\n          opacity: 0;\n          transform: scale3d(1.0, 1.0, 1) translate3d(0%, 0%, 0);\n        }\n        10% {\n          opacity: 1;\n        }\n        90% {\n          opacity: 1;\n        }\n        100% {\n          opacity: 0;\n          transform: scale3d(var(--end-scale, 1.3), var(--end-scale, 1.3), 1) \n                     translate3d(var(--end-x, 0%), var(--end-y, 0%), 0);\n        }\n      }\n\n      /* Fast zoom out - starts quickly then slows down */\n      @keyframes ken-burns-zoom-out-fast {\n        0% {\n          opacity: 0;\n          transform: scale3d(var(--start-scale, 2.0), var(--start-scale, 2.0), 1) \n                     translate3d(var(--start-x, 0%), var(--start-y, 0%), 0);\n        }\n        10% {\n          opacity: 1;\n        }\n        30% {\n          transform: scale3d(var(--mid-scale, 1.2), var(--mid-scale, 1.2), 1) \n                     translate3d(var(--mid-x, 0%), var(--mid-y, 0%), 0);\n        }\n        90% {\n          opacity: 1;\n        }\n        100% {\n          opacity: 0;\n          transform: scale3d(1.0, 1.0, 1) translate3d(0%, 0%, 0);\n        }\n      }\n    ",document.head.appendChild(e)},createStaticBackdropKeyframes:function(){if(document.getElementById("backdrop-static"))return;const e=document.createElement("style");e.id="backdrop-static",e.textContent="\n    @keyframes backdrop-cycle {\n      0% {\n        opacity: 0;\n      }\n      10% {\n        opacity: 1;\n      }\n      90% {\n        opacity: 1;\n      }\n      100% {\n        opacity: 0;\n      }\n    }\n  ",document.head.appendChild(e)},render:function(e,t,n,o){var i,s;if(this.suspended)return void console.debug("[MMM-OneDrive] Module is suspended, skipping render");const a=(null==o?void 0:o.focalPoint)||null,r=new Date,l=document.getElementById("ONEDRIVE_PHOTO_BACKDROP"),c=document.getElementById("ONEDRIVE_PHOTO_CURRENT");c.textContent="",l.style.backgroundImage=`url(${e})`,c.innerHTML=`<img src="${e}" style="width: 100%; height: 100%; object-fit: contain; display: block;">`,l.style.animation="none",l.offsetHeight,this.createStaticBackdropKeyframes();const d=this.config.updateInterval/1e3;if(l.style.animation=`backdrop-cycle ${d}s linear forwards`,this.config.leftMargin){let e=document.getElementById("ONEDRIVE_PHOTO_CLIP_WRAPPER");if(!e){e=document.createElement("div"),e.id="ONEDRIVE_PHOTO_CLIP_WRAPPER",e.style.position="absolute",e.style.overflow="hidden",e.style.top="10px",e.style.bottom="10px";c.parentNode.insertBefore(e,c),e.appendChild(c)}e.style.left=this.config.leftMargin,e.style.right="10px",c.style.left="0",c.style.right="0",c.style.top="0",c.style.bottom="0",c.style.width="100%",c.style.height="100%",c.style.overflow=""}else{const e=document.getElementById("ONEDRIVE_PHOTO_CLIP_WRAPPER");if(e){const t=e.parentNode;t.insertBefore(c,e),t.removeChild(e),c.style.left="10px",c.style.right="10px",c.style.top="10px",c.style.bottom="10px"}}if(!1!==this.config.kenBurnsEffect)if(a){const e=Number(null===(i=t.mediaMetadata)||void 0===i?void 0:i.width),n=Number(null===(s=t.mediaMetadata)||void 0===s?void 0:s.height);if(e&&n){let i=100*((a.x+a.width/2)/e),s=100*((a.y+a.height/2)/n);i=Math.max(20,Math.min(80,i)),s=Math.max(20,Math.min(80,s)),console.log(`[MMM-OneDrive] Using face-detected focal point: ${i.toFixed(1)}%, ${s.toFixed(1)}%`),this.applyKenBurnsAnimation(c,i,s,t,a,o)}else{console.warn("[MMM-OneDrive] Missing image dimensions for focal point conversion, using random");const e=60*Math.random()+20,n=60*Math.random()+20;this.applyKenBurnsAnimation(c,e,n,t,a,o)}}else{const e=60*Math.random()+20,n=60*Math.random()+20;console.log(`[MMM-OneDrive] Using random focal point: ${e.toFixed(1)}%, ${n.toFixed(1)}%`),this.applyKenBurnsAnimation(c,e,n,t,null,o)}else c.style.removeProperty("animation"),c.style.removeProperty("overflow");this.applyCommonStyling(c,t,n,r,!1!==this.config.kenBurnsEffect,o)},applyKenBurnsAnimation:function(e,t,n,o,i,s){const a=this.config.updateInterval/1e3,r=(null==s?void 0:s.animationType)||"zoom_out",l=(null==s?void 0:s.animationReason)||"no_backend_data";console.log(`[MMM-OneDrive] üé¨ Using backend animation decision: ${r} (${l}) for ${o.filename}`),this.applyCSSKenBurns(e,t,n,o,a,i,{type:r,reason:l})},applyCSSKenBurns:function(e,t,n,o,i,s,a){var r,l;this.createStaticKenBurnsKeyframes();const c=Number(null===(r=o.mediaMetadata)||void 0===r?void 0:r.width)||0,d=Number(null===(l=o.mediaMetadata)||void 0===l?void 0:l.height)||0,u=e.querySelector("img");switch(e.kenBurnsAnimation&&(e.kenBurnsAnimation.cancel(),delete e.kenBurnsAnimation),u.style.animation="none",u.style.opacity="1",u.style.transform="",e.style.overflow="hidden",u.style.willChange="transform, opacity",u.style.backfaceVisibility="hidden",u.style.transformStyle="preserve-3d",u.style.transformOrigin="center center",(null==a?void 0:a.type)||"static"){case"static":u.style.animation=`ken-burns-static ${i}s linear forwards`,console.debug(`[MMM-OneDrive] Applied static animation (${a.reason})`);break;case"zoom_out":this.applyZoomOutAnimation(u,t,n,s,i,c,d,!1),console.debug(`[MMM-OneDrive] Applied zoom out animation (${a.reason})`);break;case"zoom_out_fast":this.applyZoomOutAnimation(u,t,n,s,i,c,d,!0),console.debug(`[MMM-OneDrive] Applied fast zoom out animation (${a.reason})`);break;case"zoom_in":this.applyZoomInAnimation(u,t,n,s,i,c,d),console.debug(`[MMM-OneDrive] Applied zoom in animation (${a.reason})`);break;default:u.style.animation=`ken-burns-static ${i}s linear forwards`,console.warn(`[MMM-OneDrive] Unknown animation type: ${null==a?void 0:a.type}, using static`)}const m={cancel:()=>{u.style.animation="none",u.style.removeProperty("--start-scale"),u.style.removeProperty("--start-x"),u.style.removeProperty("--start-y"),u.style.removeProperty("--end-scale"),u.style.removeProperty("--end-x"),u.style.removeProperty("--end-y"),u.style.removeProperty("--mid-scale"),u.style.removeProperty("--mid-x"),u.style.removeProperty("--mid-y")}};e.kenBurnsAnimation=m,console.debug("[MMM-OneDrive] CSS Ken Burns animation started:",{animationType:(null==a?void 0:a.type)||"static",totalDuration:`${i}s`,filename:o.filename,hasFocalPoint:!!s})},applyZoomOutAnimation:function(e,t,n,o,i,s,a,r){let l=1.5,c=0,d=0;if(r&&(l=2),o&&s&&a){const e=100/(o.width/s*100),i=100/(o.height/a*100),u=Math.min(e,i),m=r?1.3:1;l=Math.max(1.1,Math.min(2.5,u*m)),!1!==this.config.kenBurnsCenterStart&&(c=50-t,d=50-n)}if(e.style.setProperty("--start-scale",l.toString()),e.style.setProperty("--start-x",`${c}%`),e.style.setProperty("--start-y",`${d}%`),r){const t=1+.3*(l-1),n=.3*c,o=.3*d;e.style.setProperty("--mid-scale",t.toString()),e.style.setProperty("--mid-x",`${n}%`),e.style.setProperty("--mid-y",`${o}%`),e.style.animation=`ken-burns-zoom-out-fast ${i}s ease-out forwards`}else e.style.animation=`ken-burns-zoom-out ${i}s linear forwards`},applyZoomInAnimation:function(e,t,n,o,i,s,a){let r=1.3,l=0,c=0;if(o&&s&&a){const e=80/(o.width/s*100),i=80/(o.height/a*100),d=Math.min(e,i);r=Math.max(1.1,Math.min(2,d)),!1!==this.config.kenBurnsCenterStart&&(l=50-t,c=50-n)}e.style.setProperty("--end-scale",r.toString()),e.style.setProperty("--end-x",`${l}%`),e.style.setProperty("--end-y",`${c}%`),e.style.animation=`ken-burns-zoom-in ${i}s linear forwards`},applyCommonStyling:function(e,t,n,o,i,s){var a,r,l,c;i||e.classList.add("animated");const d=document.getElementById("ONEDRIVE_PHOTO_INFO");if(this.config.autoInfoPosition){let e=(e,t)=>{const n=new Date;return[[0,"none","none",0],["none","none",0,0],["none",0,0,"none"],[0,0,"none","none"]][Math.floor(n.getMinutes()/15)]};"function"==typeof this.config.autoInfoPosition&&(e=this.config.autoInfoPosition);const[o,i,s,a]=e(n,t);d.style.setProperty("--top",String(o)),d.style.setProperty("--left",String(i)),d.style.setProperty("--bottom",String(s)),d.style.setProperty("--right",String(a))}else d.style.setProperty("--bottom","10px"),d.style.setProperty("--right","10px");d.innerHTML="";const u=document.createElement("div");u.classList.add("photoTime"),u.innerHTML="relative"===this.config.timeFormat?moment(t.mediaMetadata.dateTimeOriginal).fromNow():moment(t.mediaMetadata.dateTimeOriginal).format(this.config.timeFormat);const m=document.createElement("div");if(m.classList.add("photoLocation"),t.mediaMetadata.location){const e=t.mediaMetadata.location;if(e.city||e.state||e.country){const t=[e.city];!e.state||"united states"!==(null===(a=e.country)||void 0===a?void 0:a.toLowerCase())&&"canada"!==(null===(r=e.country)||void 0===r?void 0:r.toLowerCase())&&e.city||t.push(e.state),e.country&&t.push(e.country),m.innerHTML=t.filter(Boolean).join(", ")}else e.latitude&&e.longitude&&(m.innerHTML=`${e.latitude.toFixed(4)}, ${e.longitude.toFixed(4)}`)}if((null===(c=null===(l=null==s?void 0:s.colorAnalysis)||void 0===l?void 0:l.dominantColors)||void 0===c?void 0:c.length)>0)try{const e=this.getMostVibrantColor(s.colorAnalysis.dominantColors);this.applyPhotoInfoStyling(d,u,m,e)}catch(e){console.warn("[MMM-OneDrive] Failed to apply color theming:",e),this.applyPhotoInfoStyling(d,u,m)}else this.applyPhotoInfoStyling(d,u,m);const h=document.createElement("div");h.classList.add("infoText"),h.appendChild(u),m.innerHTML&&h.appendChild(m),d.appendChild(h),console.debug("[MMM-OneDrive] render image done",JSON.stringify({id:t.id,filename:t.filename,duration:(new Date).getTime()-o.getTime()}))},getDom:function(){const e=document.createElement("div");e.id="ONEDRIVE_PHOTO";const t=document.createElement("div");t.id="ONEDRIVE_PHOTO_BACKDROP";const n=document.createElement("div");n.id="ONEDRIVE_PHOTO_CURRENT",-1===this.data.position.search("fullscreen")&&(this.config.showWidth&&(e.style.width=this.config.showWidth+"px"),this.config.showHeight&&(e.style.height=this.config.showHeight+"px")),n.addEventListener("animationend",(()=>{n.classList.remove("animated")}));const o=document.createElement("div");return o.id="ONEDRIVE_PHOTO_INFO",o.innerHTML="Loading...",e.appendChild(t),e.appendChild(n),e.appendChild(o),console.info("[MMM-OneDrive] Dom updated!"),e},suspend(){console.log("[MMM-OneDrive] üí§ Module suspended - stopping display timer"),this.displayTimer&&(clearTimeout(this.displayTimer),this.displayTimer=null),this.currentBlobUrl&&(URL.revokeObjectURL(this.currentBlobUrl),this.currentBlobUrl=null,console.debug("[MMM-OneDrive] üóëÔ∏è Main blob URL cleaned up during suspend")),this.currentDebugBlobUrl&&(URL.revokeObjectURL(this.currentDebugBlobUrl),this.currentDebugBlobUrl=null,console.debug("[MMM-OneDrive] üóëÔ∏è Debug blob URL cleaned up during suspend")),this.sendSocketNotification("MODULE_SUSPENDED",void 0),this.suspended=!0;document.getElementById("ONEDRIVE_PHOTO_INFO").innerHTML=""},resume(){console.log("[MMM-OneDrive] üîÑ Module resumed - restarting display cycle"),this.sendSocketNotification("MODULE_RESUMED",void 0),this.suspended=!1,this.photoCache&&!this.displayTimer&&this.scheduleNextDisplay()}})}();
//# sourceMappingURL=MMM-OneDrive.js.map
